<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background: #fff; font-family: 'Segoe UI', sans-serif; padding: 10px; font-size: 0.9rem; }
      .answer-card { background: #f8f9fa; padding: 10px; margin-bottom: 8px; border-left: 3px solid #0d6efd; font-size: 0.85rem; }
      .question-header { background: #e9ecef; padding: 8px; font-weight: 700; margin-top: 15px; margin-bottom: 8px; border-radius: 4px; font-size: 0.9rem; }
      .btn-gmail { width: 100%; font-weight: bold; background-color: #ea4335; border: none; color: white; padding: 10px; margin-top: 10px; }
      .btn-gmail:hover { background-color: #c5221f; color: white; }
      h5 { font-size: 1.1rem; font-weight: bold; color: #0d6efd; }
      .filter-box { background: #f1f3f4; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
      .answers-container { max-height: 60vh; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; padding: 5px; }
    </style>
  </head>
  <body>
    
    <div class="text-center mb-3">
      <h5>–ó–≤—ñ—Ç: <?= subject ?></h5>
    </div>

    <div class="filter-box">
      <div class="form-check">
        <input class="form-check-input" type="radio" name="period" id="p_current" value="current" checked onchange="toggleCustomDate()">
        <label class="form-check-label" for="p_current">–ê–∫—Ç—É–∞–ª—å–Ω–∏–π (45 –¥–Ω—ñ–≤)</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="period" id="p_all" value="all" onchange="toggleCustomDate()">
        <label class="form-check-label" for="p_all">–í—Å—è —ñ—Å—Ç–æ—Ä—ñ—è</label>
      </div>
      <button onclick="generateReport()" class="btn btn-primary btn-sm w-100 mt-2">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
    </div>

    <div id="answers_placeholder" class="answers-container">
      <div class="text-muted text-center small">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ"</div>
    </div>

    <div class="card p-3 shadow-sm">
      <label class="form-label fw-bold small">Email –æ—Ç—Ä–∏–º—É–≤–∞—á–∞:</label>
      <input type="email" id="emailRecipient" class="form-control form-control-sm mb-2" placeholder="user@keenethics.com">
      
      <label class="form-label fw-bold small">–¢–µ–º–∞ –ª–∏—Å—Ç–∞:</label>
      <input type="text" id="emailSubject" class="form-control form-control-sm" value="HR Feedback <?= subject ?>">

      <button id="draftBtn" onclick="createDraft()" class="btn btn-gmail btn-sm">
        üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ —á–µ—Ä–Ω–µ—Ç–∫—É (Gmail)
      </button>
      <div id="statusMsg" class="mt-2 small text-center fw-bold" style="display:none;"></div>
    </div>

    <script>
      const RAW_DATA = <?!= answersJson ?>; 
      const SUBJECT_NAME = "<?= subject ?>"; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–º'—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ –¥–ª—è JS
      const QUESTIONS = [
        "1. –Ø–∫—ñ—Å—Ç—å —Ä–æ–±–æ—Ç–∏", "2. –£–≤–∞–≥–∞ –¥–æ –¥–µ—Ç–∞–ª–µ–π", "3. –°–∞–º–æ—Å—Ç—ñ–π–Ω—ñ—Å—Ç—å", 
        "4. –ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å", "5. –ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è", "6. –†–æ–±–æ—Ç–∞ –≤ –∫–æ–º–∞–Ω–¥—ñ", 
        "7. –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å", "8. –í–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º", "9. –°—Ç—Ä–µ—Å–æ—Å—Ç—ñ–π–∫—ñ—Å—Ç—å", 
        "10. –ü—Ä–æ–¥–∞–∂ —ñ–¥–µ–π", "11. –†–æ–∑–≤–∏—Ç–æ–∫", 
        "12. –°–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏", "13. –ó–æ–Ω–∏ —Ä–æ—Å—Ç—É", "14. –©–æ –∑–∞–≤–∞–∂–∞—î"
      ];
      
      let CURRENT_FILTERED_DATA = [];

      window.onload = generateReport;

      function toggleCustomDate() { }

      function generateReport() {
        const period = document.querySelector('input[name="period"]:checked').value;
        let filteredData = [];
        
        if (period === 'all') {
          filteredData = RAW_DATA;
        } else {
          if (RAW_DATA.length > 0) {
             // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∑–∞ –¥–∞—Ç–æ—é (—Å–≤—ñ–∂—ñ –∑–≤–µ—Ä—Ö—É)
             const sorted = RAW_DATA.sort((a,b) => new Date(b.date) - new Date(a.date));
             const latestDate = new Date(sorted[0].date);
             const cutoffDate = new Date(latestDate);
             cutoffDate.setDate(cutoffDate.getDate() - 45); 
             filteredData = sorted.filter(item => new Date(item.date) >= cutoffDate);
          }
        }
        
        CURRENT_FILTERED_DATA = filteredData;
        renderAnswers(filteredData);
      }

      function renderAnswers(data) {
        const container = document.getElementById('answers_placeholder');
        container.innerHTML = "";
        if (data.length === 0) {
          container.innerHTML = "<div class='alert alert-warning small'>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö.</div>";
          return;
        }
        
        for (let q = 0; q < QUESTIONS.length; q++) {
          let hasAnswers = false;
          let html = `<div class="question-header">${QUESTIONS[q]}</div>`;
          for (let i = 0; i < data.length; i++) {
            const ans = data[i].responses[q];
            if (ans && ans.toString().trim() !== "") {
              hasAnswers = true;
              const dateStr = new Date(data[i].date).toLocaleDateString('uk-UA');
              html += `<div class="answer-card"><b>${dateStr}:</b> ${ans}</div>`;
            }
          }
          if(hasAnswers) container.innerHTML += html;
        }
      }

      function createDraft() {
        const email = document.getElementById('emailRecipient').value;
        const subject = document.getElementById('emailSubject').value;
        const btn = document.getElementById('draftBtn');
        const status = document.getElementById('statusMsg');

        if (CURRENT_FILTERED_DATA.length === 0) { alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∑–≤—ñ—Ç—É"); return; }
        
        btn.disabled = true;
        btn.innerText = "‚è≥ –û–±—Ä–æ–±–∫–∞...";
        status.style.display = 'none';

        // –û–ù–û–í–õ–ï–ù–ò–ô –¢–ï–ö–°–¢ –õ–ò–°–¢–ê
        let htmlBody = `
          <h3>HR Feedback ${SUBJECT_NAME}</h3>
          <p>–ú–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∑–±—ñ—Ä –∑–≤–æ—Ä–æ—Ç–Ω–æ–≥–æ –∑–≤'—è–∑–∫—É. –û—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:</p>
          <br>
          <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; font-family: Arial;">
        `;

        for (let q = 0; q < QUESTIONS.length; q++) {
            let answersHtml = "";
            for (let i = 0; i < CURRENT_FILTERED_DATA.length; i++) {
                 const ans = CURRENT_FILTERED_DATA[i].responses[q];
                 if (ans && String(ans).trim() !== "") {
                     answersHtml += `<div style="margin-bottom: 5px; border-bottom: 1px solid #eee;">${ans}</div>`;
                 }
            }
            if (answersHtml !== "") {
                htmlBody += `<tr><td style="width:30%; background:#f2f2f2;"><b>${QUESTIONS[q]}</b></td><td>${answersHtml}</td></tr>`;
            }
        }
        htmlBody += `</table><br><p>–ó –ø–æ–≤–∞–≥–æ—é,<br>HR Team</p>`;

        google.script.run
          .withSuccessHandler((res) => {
             btn.disabled = false;
             btn.innerText = "üìù –°—Ç–≤–æ—Ä–∏—Ç–∏ —á–µ—Ä–Ω–µ—Ç–∫—É (Gmail)";
             status.style.display = "block";
             if (res === "OK") {
               status.innerText = "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ—à—Ç—É.";
               status.style.color = "green";
             } else {
               status.innerText = "–ü–æ–º–∏–ª–∫–∞: " + res;
               status.style.color = "red";
             }
          })
          .createDraftInGmail(email, subject, htmlBody);
      }
    </script>
  </body>
</html>
